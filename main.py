import matplotlib.pyplot as plt
import numpy as np
import wave
import sys

from PyQt6 import QtWidgets, QtCore
import pyqtgraph as pg
import os
from random import randint
import struct

import pyaudio

##spf = wave.open("output.wav", "r")
##
### Extract Raw Audio from Wav File
##signal = spf.readframes(-1)
##signal = np.frombuffer(signal, np.int16)
##
### If Stereo
##if spf.getnchannels() == 2:
##    print("Just mono files")
##    sys.exit(0)
##
##plt.figure(1)
##plt.title("Signal Wave...")
##plt.plot(signal)
##plt.show()

class MainWindow(QtWidgets.QMainWindow):

    def __init__(self, *args, **kwargs):
        super(MainWindow, self).__init__(*args, **kwargs)

        self.graphWidget = pg.PlotWidget()
        self.setCentralWidget(self.graphWidget)

        self.x = list(range(100))  # 100 time points
        self.y = [randint(1,100) for _ in range(100)]  # 100 data points

##
        #spf = wave.open("output.wav", "rb")
        self.CHUNK = 1024*4
        FORMAT = pyaudio.paInt16
        CHANNELS = 1
        RATE = 44100
        p = pyaudio.PyAudio()
        self.stream = p.open(format=FORMAT,
                channels=CHANNELS,
                rate=RATE,
                input=True,
                frames_per_buffer=self.CHUNK)
        self.spf = self.stream.read(self.CHUNK)
        #self.spf = b'\xfc\xff\xfc\xff\xfe\xff\x03\x00\xff\xff\x03\x00\xf9\xff\x03\x00\x00\x00\x07\x00\n\x00\x07\x00\x03\x00\xfe\xff\x04\x00\x07\x00\x0c\x00\xff\xff\x01\x00\x05\x00\x05\x00\x05\x00\xff\xff\x02\x00\xf8\xff\x02\x00\x08\x00\xfb\xff\xfe\xff\x0c\x00\x02\x00\x05\x00\n\x00\x08\x00\x02\x00\x08\x00\x08\x00\xf6\xff\xfe\xff\x0b\x00\x05\x00\x00\x00\x01\x00\x01\x00\x00\x00\x08\x00\t\x00\x02\x00\x08\x00\xff\xff\x03\x00\n\x00\x05\x00\xfb\xff\xf7\xff\x05\x00\n\x00\x00\x00\x01\x00\n\x00\x07\x00\xfe\xff\xf7\xff\xfe\xff\xfb\xff\xfd\xff\xfb\xff\xfd\xff\x04\x00\xff\xff\x03\x00\xfc\xff\xfd\xff\x0c\x00\x03\x00\x01\x00\xfb\xff\xfd\xff\x02\x00\x07\x00\x02\x00\x07\x00\xff\xff\xfa\xff\x05\x00\x0b\x00\x01\x00\xfc\xff\x04\x00\xfa\xff\xf9\xff\x00\x00\x01\x00\x02\x00\t\x00\xfe\xff\x07\x00\x01\x00\xfb\xff\x04\x00\xf9\xff\xfa\xff\xf8\xff\x02\x00\x07\x00\xf6\xff\xff\xff\x08\x00\xfe\xff\x02\x00\xff\xff\x07\x00\t\x00\x02\x00\xff\xff\x02\x00\x08\x00\x00\x00\x01\x00\x02\x00\xff\xff\x06\x00\x05\x00\xff\xff\x02\x00\x00\x00\x01\x00\x00\x00\xf9\xff\xf9\xff\xf8\xff\xfd\xff\x01\x00\x01\x00\xfa\xff\xfe\xff\x03\x00\xfe\xff\xfb\xff\x00\x00\x01\x00\x00\x00\x02\x00\xfe\xff\x08\x00\x02\x00\x08\x00\x01\x00\x01\x00\x00\x00\x04\x00\x05\x00\x04\x00\x03\x00\xf9\xff\x08\x00\x03\x00\xf9\xff\xff\xff\x08\x00\x00\x00\x01\x00\x00\x00\x03\x00\x08\x00\xf9\xff\xff\xff\xfb\xff\xfe\xff\t\x00\x01\x00\t\x00\x08\x00\xff\xff\x02\x00\xff\xff\x06\x00\x04\x00\x04\x00\n\x00\x01\x00\x01\x00\x02\x00\x07\x00\x00\x00\x01\x00\xfd\xff\xfc\xff\x03\x00\xf9\xff\xfe\xff\x08\x00\x02\x00\xff\xff\x03\x00\x08\x00\x00\x00\x01\x00\x00\x00\x02\x00\xfc\xff\xfc\xff\x02\x00\xff\xff\x02\x00\x07\x00\x00\x00\x00\x00\x01\x00\x01\x00\x01\x00\x01\x00\x00\x00\t\x00\x02\x00\x00\x00\t\x00\n\x00\x06\x00\x02\x00\n\x00\x07\x00\x0b\x00\x02\x00\x07\x00\x03\x00\x07\x00\t\x00\x08\x00\x08\x00\n\x00\x04\x00\x05\x00\x04\x00\x05\x00\x04\x00\x06\x00\xfc\xff\x06\x00\t\x00\t\x00\x07\x00\x03\x00\x07\x00\xff\xff\x01\x00\x04\x00\x0b\x00\x00\x00\x02\x00\xf9\xff\x03\x00\x08\x00\x0b\x00\x02\x00\xfa\xff\x04\x00\xfa\xff\xfd\xff\t\x00\x01\x00\x02\x00\x08\x00\x00\x00\xff\xff\xf7\xff\xfd\xff\x01\x00\x00\x00\x01\x00\x00\x00\x08\x00\t\x00\x07\x00\x01\x00\x0c\x00\x05\x00\x04\x00\x06\x00\x03\x00\x0b\x00\x06\x00\n\x00\x06\x00\x03\x00\xff\xff\x04\x00\x05\x00\x04\x00\n\x00\t\x00\x05\x00\xf8\xff\x06\x00\x02\x00\x08\x00\x00\x00\x03\x00\x06\x00\x01\x00\x0c\x00\x03\x00\x02\x00\xfb\xff\xff\xff\x02\x00\xff\xff\x03\x00\x07\x00\x00\x00\xff\xff\xf7\xff\xfe\xff\xfd\xff\xf7\xff\xfb\xff\xfd\xff\x04\x00\x05\x00\xfc\xff\x08\x00\xfe\xff\xf9\xff\x07\x00\x03\x00\x06\x00\x04\x00\xf8\xff\x01\x00\x02\x00\x08\x00\x00\x00\x03\x00\t\x00\t\x00\x03\x00\x03\x00\x0c\x00\x00\x00\t\x00\x08\x00\x02\x00\x06\x00\xf8\xff\x06\x00\x05\x00\xfe\xff\x07\x00\x03\x00\x07\x00\xfc\xff\xfe\xff\xf9\xff\xfa\xff\x01\x00\x01\x00\x0b\x00\x03\x00\x01\x00\xff\xff\x02\x00\xf8\xff\xfa\xff\x06\x00\xfb\xff\xfe\xff\xfd\xff\x0b\x00\x07\x00\xf8\xff\x04\x00\x04\x00\x06\x00\xfc\xff\x00\x00\t\x00\x08\x00\t\x00\n\x00\x05\x00\x03\x00\x0b\x00\x07\x00\n\x00\x00\x00\t\x00\x07\x00\xf9\xff\x0b\x00\x04\x00\x04\x00\n\x00\x03\x00\xff\xff\x08\x00\x02\x00\x01\x00\t\x00\t\x00\x08\x00\n\x00\x05\x00\x03\x00\x0b\x00\x07\x00\t\x00\x02\x00\x07\x00\t\x00\x08\x00\t\x00\x07\x00\x0b\x00\x04\x00\x05\x00\t\x00\n\x00\x02\x00\x08\x00\x00\x00\xfb\xff\xff\xff\x06\x00\x02\x00\x00\x00\x03\x00\xf4\xff\xff\xff\x01\x00\x01\x00\xfb\xff\x05\x00\xfb\xff\xff\xff\x03\x00\x08\x00\x06\x00\xf9\xff\x04\x00\x05\x00\xfe\xff\xfb\xff\x06\x00\x0b\x00\x05\x00\x03\x00\t\x00\x06\x00\xfe\xff\x08\x00\x04\x00\x00\x00\x08\x00\x02\x00\x00\x00\x03\x00\x07\x00\xff\xff\x04\x00\n\x00\x08\x00\t\x00\x08\x00\t\x00\x08\x00\xf9\xff\n\x00\x06\x00\x00\x00\x01\x00\x01\x00\xfd\xff\xf7\xff\xf9\xff\xf7\xff\x08\x00\xf8\xff\x02\x00\x08\x00\x01\x00\x0b\x00\x08\x00\t\x00\x08\x00\t\x00\x08\x00\x02\x00\x06\x00\x02\x00\xff\xff\x04\x00\x06\x00\x00\x00\x01\x00\x00\x00\x07\x00\xfd\xff\xfd\xff\x02\x00\x07\x00\x01\x00\x01\x00\x0b\x00\x06\x00\x0b\x00\x03\x00\x00\x00\x00\x00\x01\x00\x08\x00\n\x00\x06\x00\x02\x00\x08\x00\xfe\xff\x05\x00\x05\x00\xfd\xff\t\x00\x02\x00\x08\x00\xf9\xff\xfa\xff\n\x00\x07\x00\t\x00\n\x00\x04\x00\x05\x00\x04\x00\x05\x00\x03\x00\x05\x00\n\x00\x05\x00\x02\x00\t\x00\x08\x00\n\x00\x04\x00\xfe\xff\x08\x00\t\x00\t\x00\x08\x00\x00\x00\x0b\x00\x05\x00\x03\x00\t\x00\x08\x00\t\x00\t\x00\x02\x00\x01\x00\x08\x00\x02\x00\t\x00\x08\x00\t\x00\n\x00\x08\x00\t\x00\x08\x00\x03\x00\xff\xff\xfb\xff\xfe\xff\xfa\xff\xff\xff\x03\x00\x08\x00\xfa\xff\x03\x00\x06\x00\xfd\xff\x03\x00\x06\x00\n\x00\x05\x00\xfa\xff\r\x00\xff\xff\xfd\xff\xfb\xff\x04\x00\xff\xff\xfb\xff\x03\x00\xfe\xff\x02\x00\t\x00\x08\x00\x01\x00\x0c\x00\x02\x00\x05\x00\x0b\x00\x01\x00\x07\x00\t\x00\x08\x00\x01\x00\x03\x00\x08\x00\xfb\xff\xfb\xff\x07\x00\x03\x00\xfb\xff\xf8\xff\t\x00\x08\x00\x01\x00\xff\xff\x05\x00\x06\x00\x03\x00\x0b\x00\x06\x00\x0b\x00\x02\x00\x00\x00\x07\x00\x08\x00\xfe\xff\xfc\xff\x0c\x00\x02\x00\x06\x00\x03\x00\x05\x00\x04\x00\xfe\xff\x02\x00\x08\x00\t\x00\x08\x00\xfd\xff\xfb\xff\x03\x00\xfe\xff\x07\x00\x01\x00\x07\x00\n\x00\x08\x00\x01\x00\x0b\x00\x01\x00\xfe\xff\x07\x00\x02\x00\x0c\x00\x00\x00\x03\x00\xf8\xff\x02\x00\x06\x00\xfa\xff\n\x00\xf9\xff\x01\x00\x04\x00\x05\x00\x05\x00\xff\xff\x02\x00\x07\x00\x01\x00\xf8\xff\x05\x00\x05\x00\x00\x00\x00\x00\x01\x00\x01\x00\x01\x00\x07\x00\t\x00\xff\xff\x03\x00\t\x00\x08\x00\x08\x00\t\x00\x04\x00\xff\xff\x01\x00\x00\x00\x08\x00\n\x00\x07\x00\x01\x00\x0c\x00\x0f\x00\x02\x00\x06\x00\x05\x00\xfe\xff\x02\x00\xff\xff\n\x00\x06\x00\x03\x00\x06\x00\x02\x00\x0b\x00\x04\x00\xfe\xff\x07\x00\t\x00\x01\x00\x07\x00\x0b\x00\x05\x00\x03\x00\x08\x00\x0b\x00\x02\x00\x05\x00\t\x00\x08\x00\x08\x00\t\x00\x07\x00\x02\x00\x08\x00\x00\x00\x00\x00\x04\x00\n\x00\x02\x00\x04\x00\x0b\x00\x00\x00\xfa\xff\xff\xff\x02\x00\xfe\xff\x06\x00\x04\x00\x06\x00\x04\x00\x04\x00\t\x00\x07\x00\x08\x00\x01\x00\xff\xff\x03\x00\x06\x00\x02\x00\x0c\x00\xfd\xff\xfd\xff\x01\x00\x05\x00\x0b\x00\x06\x00\n\x00\x05\x00\x04\x00\x05\x00\x02\x00\x0b\x00\x02\x00\x00\x00\x00\x00\x01\x00\x00\x00\xfa\xff\x0b\x00\x03\x00\xf8\xff\x07\x00\x04\x00\xfe\xff\x07\x00\x03\x00\xff\xff\x01\x00\x01\x00\x02\x00\xfe\xff\xfa\xff\x04\x00\xfa\xff\xfd\xff\x01\x00\x06\x00\n\x00\xf9\xff\x01\x00\t\x00\x07\x00\x00\x00\x01\x00\x00\x00\x01\x00\xff\xff\x07\x00\n\x00\x08\x00\x08\x00\x01\x00\n\x00\x06\x00\xff\xff\x00\x00\x05\x00\x05\x00\xff\xff\x01\x00\x06\x00\x03\x00\x07\x00\n\x00\x05\x00\x01\x00\xfe\xff\x07\x00\x04\x00\x00\x00\x01\x00\x01\x00\x07\x00\x03\x00\x07\x00\x02\x00\t\x00\x08\x00\x07\x00\n\x00\x03\x00\xff\xff\x00\x00\x01\x00\x00\x00\x02\x00\t\x00\t\x00\x08\x00\t\x00\x03\x00\x06\x00\x03\x00\x06\x00\x03\x00\x06\x00\n\x00\x07\x00\t\x00\x07\x00\t\x00\x08\x00\t\x00\x08\x00\n\x00\x07\x00\t\x00\x06\x00\x03\x00\x08\x00\n\x00\x04\x00\x03\x00\t\x00\x08\x00\t\x00\x08\x00\x02\x00\x08\x00\t\x00\x08\x00\t\x00\x08\x00\t\x00\x08\x00\t\x00\x08\x00\x0f\x00\t\x00\x07\x00\x01\x00\n\x00\x0f\x00\x07\x00\t\x00\x08\x00\t\x00\x08\x00\t\x00\x07\x00\x01\x00\x00\x00\x02\x00\t\x00\x08\x00\t\x00\x04\x00\x03\x00\x0b\x00\x06\x00\x03\x00\x0e\x00\x04\x00\x05\x00\x03\x00\t\x00\x07\x00\n\x00\x03\x00\x04\x00\n\x00\x07\x00\t\x00\x08\x00\x08\x00\x00\x00\x0b\x00\x03\x00\x05\x00\x08\x00\n\x00\xfd\xff\xfd\xff\n\x00\t\x00\x08\x00\x00\x00\x01\x00\xff\xff\x03\x00\n\x00\x02\x00\x05\x00\x04\x00\xff\xff\t\x00\x07\x00\n\x00\x05\x00\x03\x00\n\x00\x08\x00\x08\x00\t\x00\x03\x00\xf9\xff\x07\x00\t\x00\x07\x00\t\x00\x08\x00\x08\x00\x08\x00\x08\x00\t\x00\x02\x00\x05\x00\n\x00\xff\xff\x03\x00\x08\x00\n\x00\x06\x00\x00\x00\x00\x00\x06\x00\t\x00\x08\x00\t\x00\x07\x00\t\x00\x08\x00\x08\x00\x08\x00\t\x00\t\x00\x08\x00\t\x00\x07\x00\x08\x00\x08\x00\t\x00\x07\x00\n\x00\x05\x00\x03\x00\n\x00\x07\x00\x08\x00\x08\x00\t\x00\x01\x00\x00\x00\xf9\xff\x03\x00\x07\x00\xff\xff\x01\x00\x00\x00\x05\x00\t\x00\x01\x00\x06\x00\t\x00\x01\x00\n\x00\x07\x00\n\x00\x04\x00\x05\x00\x05\x00\xfd\xff\x08\x00\x02\x00\x00\x00\x08\x00\x08\x00\x08\x00\x08\x00\x08\x00'
        #print(spf)

        # Extract Raw Audio from Wav File
##        signal = spf.readframes(-1)
##        signal = np.frombuffer(signal, np.int16)

        #wf_data = struct.unpack(str(2 * 1024) + 'B', self.spf)
        #wf_data = np.array(wf_data, dtype='b')[::2] + 128


##
        self.blk = pg.mkColor(0,0,0)
        self.graphWidget.setBackground(self.blk)

        self.pen = pg.mkPen(color=(195, 0, 255))
        #self.data_line = self.graphWidget.plot(wf_data, pen=pen)
        self.graphWidget.setYRange(0, 255, padding=0)
        self.graphWidget.setXRange(0, 1024*4, padding=0.005)

###################
        self.timer = QtCore.QTimer()
        self.timer.start(0)
        self.timer.timeout.connect(self.update_plot_data)
        self.timer.start()

    def update_plot_data(self):
        self.graphWidget.clear()
        self.spf = self.stream.read(self.CHUNK)
        wf_data = struct.unpack(str(8 * 1024) + 'B', self.spf)
        wf_data = np.array(wf_data, dtype='b')[::2]+128
        self.data_line = self.graphWidget.plot(wf_data, pen=self.pen)

##        self.timer = QtCore.QTimer()
##        self.timer.start(50)
##        self.timer.timeout.connect(self.update_plot_data)
##        self.timer.start()
##
##    def update_plot_data(self):
##        self.x = self.x[1:]  # Remove the first y element.
##        self.x.append(self.x[-1] + 1)  # Add a new value 1 higher than the last.
##
##        self.y = self.y[1:]  # Remove the first
##        self.y.append( randint(0,100))  # Add a new random value.
##
##        self.data_line.setData(self.x, self.y)  # Update the data.

app = QtWidgets.QApplication(sys.argv)
w = MainWindow()
w.show()
app.exec()
sys.exit(0)
